5. 유효한 JSON 형식인지 확인하세요
6. 반드시 { 로 시작하고 } 로 끝나야 합니다`

    const userPrompt = `[웰니스 코칭 상담 요청]

이것은 체성분 측정 결과(InBody)를 기반으로 한 웰니스 코칭 상담입니다.
의료 진단이나 치료가 아닌, 건강한 라이프스타일과 영양 계획을 위한 분석입니다.

목표: ${goal}
말투: ${tone}

위 체성분 분석 결과 이미지를 보고, 웰니스 코칭 관점에서 영양 보충 계획을 
반드시 순수한 JSON 형식으로만 출력해주세요.

중요:
1. JSON 이외의 텍스트는 절대 포함하지 마세요
2. 설명이나 주석을 추가하지 마세요
3. 반드시 중괄호 { 로 시작하고 } 로 끝나야 합니다
4. 모든 문자열은 반드시 큰따옴표 " "로 감싸야 합니다
5. JSON 형식이 유효해야 합니다 (쉼표, 괄호 등 문법 확인)`

    // OpenAI API 호출
    const apiKey = c.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY
    const baseURL = c.env.OPENAI_BASE_URL || process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'

    if (!apiKey) {
      return c.json({ 
        error: 'API 키가 설정되지 않았습니다. OpenAI API 키를 설정해주세요.' 
      }, 500)
    }

    const response = await fetch(`${baseURL}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          {
            role: 'user',
            content: [
              { type: 'text', text: userPrompt },
              { type: 'image_url', image_url: { url: imageUrl } }
            ]
          }
        ],
        max_tokens: 8000,
        temperature: 0.8
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('OpenAI API Error:', response.status, response.statusText)
      console.error('Error details:', errorText)
      return c.json({ 
        error: `AI 분석 실패: ${response.status} ${response.statusText}`,
        details: errorText
      }, 500)
    }

    const data = await response.json()
    const content = data.choices[0]?.message?.content || ''
    
    console.log('AI Response length:', content.length)
    console.log('AI Response preview:', content.substring(0, 200))

    console.log('AI Response length:', content.length)
    console.log('AI Response preview:', content.substring(0, 200))

    // JSON 추출 (여러 방법 시도)
    let jsonString = ''
    
    // 방법 1: ```json 코드 블록 안의 JSON
    const codeBlockMatch = content.match(/```json\s*([\s\S]*?)\s*```/)
    if (codeBlockMatch) {
      jsonString = codeBlockMatch[1].trim()
    } else {
      // 방법 2: 첫 { 부터 마지막 } 까지
      const jsonMatch = content.match(/\{[\s\S]*\}/)
      if (jsonMatch) {
        jsonString = jsonMatch[0]
      }
    }

    if (!jsonString) {
      console.error('No JSON found in response')
      return c.json({ 
        error: 'AI 응답에서 JSON을 찾을 수 없습니다. 다시 시도해주세요.', 
        raw_response: content.substring(0, 500)
      }, 500)
    }

    try {
      const result = JSON.parse(jsonString)
      console.log('JSON parsed successfully')
      return c.json(result)
    } catch (parseError) {
      console.error('JSON parse error:', parseError)
      console.error('Failed JSON string preview:', jsonString.substring(0, 500))
      return c.json({ 
        error: 'JSON 파싱 실패. AI 응답 형식이 올바르지 않습니다. 다시 시도해주세요.', 
        raw_response: content.substring(0, 500),
        parse_error: parseError instanceof Error ? parseError.message : 'Unknown error'
      }, 500)
    }

  } catch (error) {
    console.error('Error:', error)
    return c.json({ 
      error: error instanceof Error ? error.message : '알 수 없는 오류가 발생했습니다.' 
    }, 500)
  }
})

// 재분석 API (수정된 수치로)
app.post('/api/reanalyze', async (c) => {
  try {
    const body = await c.req.json()
    const { metrics, goal, tone, original_summary } = body

    if (!metrics || !Array.isArray(metrics)) {
      return c.json({ error: '수치 데이터가 없습니다.' }, 400)
    }

    // 수치를 텍스트로 변환
    const metricsText = metrics.map(m => `${m.name}: ${m.value} (${m.status})`).join('\n')

    // 시스템 프롬프트 - 초기 분석과 동일하게 상세하게
    const systemPrompt = `[IMPORTANT DISCLAIMER]
This is NOT medical diagnosis or treatment. This is a wellness coaching analysis for nutritional supplement recommendations based on body composition data from a commercial InBody device.

[면책조항 - 웰니스 코칭 목적]
이 분석은 의료 진단, 질병 치료, 처방이 아닙니다.
상용 체성분 분석 기기(InBody)의 데이터를 기반으로 한 웰니스 코칭 및 영양 보충제 추천입니다.

역할: 허벌라이프 프리미어 웰니스 코치이자 인바디 체성분 분석 전문가

아래 인바디 수치를 기반으로 웰니스 코칭 분석 결과를 JSON 형식으로 생성하세요.

**출력 형식 - 반드시 준수**:
{
  "one_line_summary": "전체 요약 한 문장",
  "metrics": [
    {"name":"체중","value":"58.2kg","status":"정상"},
    {"name":"골격근량","value":"22.0kg","status":"정상"},
    ...7개 항목 모두
  ],
  "interpretation": [
    {"title":"근육량과 기초대사 상태","detail":"상세 설명 3-4문장"},
    {"title":"체지방 분포와 대사 건강","detail":"상세 설명 3-4문장"},
    {"title":"체성분 밸런스와 개선 방향","detail":"상세 설명 3-4문장"}
  ],
  "herbalife_solution": {
    "daily_routine": [
      {"timing":"아침","items":[{"product":"제품명","why":"이유","how":"방법"}]},
      {"timing":"점심","items":[...]},
      {"timing":"저녁","items":[...]}
    ],
    "fat_management": [
      {"point":"포인트","action":"실천법","product_suggestion":"제품"}
    ],
    "muscle_metabolism": [
      {"point":"포인트","action":"실천법","product_suggestion":"제품"}
    ],
    "compliance_note":"면책 문구"
  },
  "coach_script": [
    "문장1",
    "문장2",
    "문장3",
    "문장4",
    "문장5"
  ],
  "guide_4weeks": [
    {"week":"1주","focus":"내용","checkpoints":["항목1","항목2"]},
    {"week":"2주","focus":"내용","checkpoints":["항목1","항목2"]},
    {"week":"3주","focus":"내용","checkpoints":["항목1","항목2"]},
    {"week":"4주","focus":"내용","checkpoints":["항목1","항목2"]}
  ],
  "sms_result": "250-300자 문자 내용"
}`

    const userPrompt = `[웰니스 코칭 상담 요청 - 정확한 수치 기반]

목표: ${goal}
말투: ${tone}

인바디 체성분 분석 결과 (사용자 확인 완료):
${metricsText}

**지시사항**:
1. 위 수치는 사용자가 확인한 정확한 값입니다
2. metrics 배열에 위 수치를 그대로 사용하세요
3. 반드시 JSON 형식으로만 출력하세요 (텍스트 설명 없이)
4. 다음 필드를 모두 포함해야 합니다:
   - one_line_summary (문자열)
   - metrics (배열 - 위 수치 그대로)
   - interpretation (배열 - 3개 항목)
   - herbalife_solution (객체 - daily_routine, fat_management, muscle_metabolism, compliance_note 포함)
   - coach_script (배열 - 5-7개 문장)
   - guide_4weeks (배열 - 4개 주차)
   - sms_result (문자열 - 250-300자)

**중요**: JSON 시작 { 과 끝 } 만 출력하세요. 설명이나 주석 없이.`

    const apiKey = c.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY
    const baseURL = c.env.OPENAI_BASE_URL || process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'

    if (!apiKey) {
      return c.json({ error: 'API 키가 설정되지 않았습니다.' }, 500)
    }

    const response = await fetch(`${baseURL}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        max_tokens: 8000,
        temperature: 0.5
      })
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('OpenAI API Error:', response.status, response.statusText)
      console.error('Error details:', errorText)
      return c.json({ 
        error: `AI 분석 실패: ${response.status} ${response.statusText}`,
        details: errorText
      }, 500)
    }

    const data = await response.json()
    const content = data.choices[0]?.message?.content || ''
    
    console.log('Reanalysis Response length:', content.length)
    console.log('Reanalysis Response preview:', content.substring(0, 200))

    // JSON 추출
    let jsonString = ''
    
    const codeBlockMatch = content.match(/```json\s*([\s\S]*?)\s*```/)
    if (codeBlockMatch) {
      jsonString = codeBlockMatch[1].trim()
    } else {
      const jsonMatch = content.match(/\{[\s\S]*\}/)
      if (jsonMatch) {
        jsonString = jsonMatch[0]
      }
    }

    if (!jsonString) {
      return c.json({ 
        error: 'AI 응답에서 JSON을 찾을 수 없습니다.',
        raw_response: content.substring(0, 500)
      }, 500)
    }

    try {
      const result = JSON.parse(jsonString)
      
      // metrics가 누락된 경우 입력 받은 metrics 그대로 사용
      if (!result.metrics || !Array.isArray(result.metrics)) {
        console.warn('AI response missing metrics, using input metrics');
        result.metrics = metrics;
      }
      
      console.log('Reanalysis JSON parsed successfully')
      console.log('Result metrics:', result.metrics)
      return c.json(result)
    } catch (parseError) {
      return c.json({ 
        error: 'JSON 파싱 실패.',
        raw_response: content.substring(0, 500),
        parse_error: parseError instanceof Error ? parseError.message : 'Unknown error'
      }, 500)
    }

  } catch (error) {
    console.error('Reanalysis Error:', error)
    return c.json({ 
      error: error instanceof Error ? error.message : '알 수 없는 오류가 발생했습니다.' 
    }, 500)
  }
})

export default app
